#!/bin/bash

# Note: macOS installer scripts run as root
# Get the actual user who invoked the installer (not root)
ACTUAL_USER="${USER}"
if [ "${ACTUAL_USER}" = "root" ]; then
    ACTUAL_USER=$(stat -f "%Su" /dev/console)
fi
ACTUAL_HOME=$(eval echo ~${ACTUAL_USER})

echo "Checking Homebrew installation for user: ${ACTUAL_USER}"

# Determine architecture and set Homebrew path
# Use sysctl to get true architecture (not affected by Rosetta)
ARCH=$(sysctl -n hw.optional.arm64 2>/dev/null)
if [ "${ARCH}" = "1" ]; then
    BREW_PREFIX="/opt/homebrew"
else
    BREW_PREFIX="/usr/local"
fi

# Check if Homebrew is installed
if [ ! -x "${BREW_PREFIX}/bin/brew" ]; then
    echo "Homebrew is not installed at ${BREW_PREFIX}"
    echo ""
    echo "Please install Homebrew first by running:"
    echo '/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"'
    echo ""
    echo "Or visit: https://brew.sh"
    exit 1
fi

echo "Homebrew found at ${BREW_PREFIX}"

# Tap stuffbucket repository if not already tapped
if ! sudo -u "${ACTUAL_USER}" "${BREW_PREFIX}/bin/brew" tap | grep -q 'stuffbucket/tap'; then
    echo "Tapping stuffbucket/tap..."
    sudo -u "${ACTUAL_USER}" "${BREW_PREFIX}/bin/brew" tap stuffbucket/tap || {
        echo "Error: Failed to tap stuffbucket/tap"
        exit 1
    }
else
    echo "stuffbucket/tap already tapped"
fi

# Add Homebrew to shell profiles if not already present
for SHELL_RC in "${ACTUAL_HOME}/.zshrc" "${ACTUAL_HOME}/.bashrc" "${ACTUAL_HOME}/.bash_profile"; do
    if [ -f "$SHELL_RC" ]; then
        if ! grep -q "eval.*${BREW_PREFIX}/bin/brew shellenv" "$SHELL_RC" 2>/dev/null; then
            echo "" >> "$SHELL_RC"
            echo "# Added by stuffbucket Homebrew tap installer" >> "$SHELL_RC"
            echo "eval \"\$(${BREW_PREFIX}/bin/brew shellenv)\"" >> "$SHELL_RC"
            chown "${ACTUAL_USER}:$(id -gn ${ACTUAL_USER})" "$SHELL_RC"
            echo "Added Homebrew to $SHELL_RC"
        fi
    fi
done

echo "stuffbucket tap setup complete!"
exit 0
