name: Publish Installers

on:
  push:
    branches: [ main ]
    paths:
      - 'Formula/*.rb'
      - 'pkgs/**'
      - '.github/workflows/publish-installers.yml'
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout homebrew-tap
      uses: actions/checkout@v4
      with:
        path: homebrew-tap
    
    - name: Set up Homebrew
      uses: Homebrew/actions/setup-homebrew@master
    
    - name: Extract versions
      id: versions
      working-directory: homebrew-tap
      run: |
        brew tap stuffbucket/tap $(pwd)
        LIMA_VER=$(brew info --json=v2 stuffbucket/tap/lima | jq -r '.formulae[0].versions.stable')
        VSCODE_VER=$(brew info --json=v2 stuffbucket/tap/vscode-lima | jq -r '.formulae[0].versions.stable')
        echo "lima_version=${LIMA_VER}" >> $GITHUB_OUTPUT
        echo "vscode_version=${VSCODE_VER}" >> $GITHUB_OUTPUT
        echo "homebrew_version=1.0.0" >> $GITHUB_OUTPUT
    
    - name: Verify packages exist
      working-directory: homebrew-tap
      run: |
        echo "Verifying pre-built packages..."
        ls -lh pkgs/homebrew/stuffbucket-homebrew-*.pkg
        ls -lh pkgs/lima/stuffbucket-lima-*.pkg
        ls -lh pkgs/vscode-lima/stuffbucket-vscode-lima-*.pkg
        echo "âœ… All packages found"
    
    - name: Checkout installers repo
      uses: actions/checkout@v4
      with:
        repository: stuffbucket/installers
        token: ${{ secrets.INSTALLERS_PAT }}
        path: installers
        fetch-depth: 0  # Fetch all history including tags
    
    - name: Copy packages to installers repo
      run: |
        mkdir -p installers/macos
        cp homebrew-tap/pkgs/homebrew/stuffbucket-homebrew-*.pkg installers/macos/
        cp homebrew-tap/pkgs/lima/stuffbucket-lima-*.pkg installers/macos/
        cp homebrew-tap/pkgs/vscode-lima/stuffbucket-vscode-lima-*.pkg installers/macos/
        
        # Generate checksums
        cd installers/macos
        shasum -a 256 *.pkg > SHA256SUMS
        
        # Create version manifest
        cat > versions.json <<EOF
        {
          "homebrew": "${{ steps.versions.outputs.homebrew_version }}",
          "lima": "${{ steps.versions.outputs.lima_version }}",
          "vscode-lima": "${{ steps.versions.outputs.vscode_version }}",
          "updated": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "commit": "${{ github.sha }}"
        }
        EOF
    
    - name: Create release tag
      working-directory: installers
      run: |
        TAG="lima-v${{ steps.versions.outputs.lima_version }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Fetch all tags to check if tag exists remotely
        git fetch --tags
        
        # Check if tag exists (local or remote)
        if git rev-parse "${TAG}" >/dev/null 2>&1; then
          echo "Tag ${TAG} already exists, skipping release"
          echo "tag_exists=true" >> $GITHUB_ENV
          exit 0
        fi
        
        # Add package files
        git add macos/
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit, but no tag exists - will create tag on current HEAD"
        else
          # Commit changes
          git commit -m "Update macOS installers

        - Lima: ${{ steps.versions.outputs.lima_version }}
        - VS Code Lima: ${{ steps.versions.outputs.vscode_version }}
        - Homebrew: ${{ steps.versions.outputs.homebrew_version }}

        Source: stuffbucket/homebrew-tap@${{ github.sha }}"
          git push origin main
        fi
        
        # Create and push tag
        git tag -a "${TAG}" -m "Release ${TAG}"
        git push origin "${TAG}"
        echo "tag_exists=false" >> $GITHUB_ENV
    
    - name: Create GitHub Release
      if: env.tag_exists != 'true'
      uses: softprops/action-gh-release@v1
      with:
        repository: stuffbucket/installers
        tag_name: lima-v${{ steps.versions.outputs.lima_version }}
        name: Lima ${{ steps.versions.outputs.lima_version }}
        body: |
          # macOS Installer Packages
          
          ## What's Included
          - **stuffbucket-homebrew-1.0.0.pkg** - Homebrew tap setup
          - **stuffbucket-lima-${{ steps.versions.outputs.lima_version }}.pkg** - Lima virtual machines
          - **stuffbucket-vscode-lima-${{ steps.versions.outputs.vscode_version }}.pkg** - VS Code extension
          
          ## Installation
          
          Install in order:
          1. Homebrew package (sets up tap)
          2. Lima package
          3. VS Code Lima package (optional)
          
          ## Checksums
          
          See `SHA256SUMS` file for package verification.
          
          ---
          Built from: stuffbucket/homebrew-tap@${{ github.sha }}
        files: |
          installers/macos/*.pkg
          installers/macos/SHA256SUMS
          installers/macos/versions.json
        token: ${{ secrets.INSTALLERS_PAT }}
