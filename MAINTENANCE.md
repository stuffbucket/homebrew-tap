# Maintenance Guide

This document covers development workflows and maintenance procedures for the homebrew-tap repository.

## Development Setup

### Install Git Hooks

Enable pre-push CI validation:

```bash
ln -sf ../../.github/hooks/pre-push .git/hooks/pre-push
```

This runs tests before pushing to catch issues early.

## Formula Updates

Formulas are automatically updated by their source repository release workflows using GoReleaser.

When a project (e.g., coop) creates a new release tag, GoReleaser:
1. Builds multi-platform binaries
2. Generates the Homebrew formula
3. Commits to this tap repository

See [GORELEASER.md](GORELEASER.md) for adding new formulas.

## Testing

### Run All Tests

```bash
make test
```

This runs shellcheck and installer validation tests.

### Individual Test Targets

```bash
make shellcheck        # Lint installer scripts
make test-installers   # Validate syntax, permissions, security
make lint              # Run all linting
make audit             # Run brew audit on formulas
```

### CI Testing Locally

Requires [act](https://github.com/nektos/act):

```bash
brew install act
make ci
```

## Maintenance Commands

### Show Formula Information

```bash
make info              # Display versions and URLs
make list-formulas     # List all available formulas
```

### Audit Formulas

```bash
make audit             # Run brew audit --strict on all formulas
```

Note: GoReleaser-generated formulas may show warnings about methods defined in blocks. This is expected and handled by `.rubocop.yml`.

## Adding New Formulas

1. Configure `.goreleaser.yaml` in the source project
2. Create `install/<formula-name>` installer script
3. Update README.md with formula documentation
4. Tag and release the source project

See [GORELEASER.md](GORELEASER.md) for detailed instructions.

## Repository Structure

```
.
├── Formula/             # Homebrew formulas (auto-generated by GoReleaser)
├── install/             # Per-formula installer scripts
├── .github/
│   ├── workflows/       # CI automation
│   └── hooks/           # Git hooks
├── .rubocop.yml         # Ruby linting config (allows GoReleaser patterns)
├── Makefile             # Development commands
├── README.md            # User-facing documentation
├── MAINTENANCE.md       # This file
└── GORELEASER.md        # GoReleaser integration guide
```

## Troubleshooting

### Formula Audit Warnings

GoReleaser generates formulas with `def` methods inside `on_macos`/`on_linux` blocks. Homebrew's strict audit flags this, but it's handled by:

1. `.rubocop.yml` - Disables `Style/MethodDefinedInBlock` check
2. `.github/workflows/tests.yml` - Makes audit non-fatal (`|| true`)

This matches the pattern used by other GoReleaser-based taps.

### Installer Tests Failing

Run individual checks:

```bash
shellcheck install/coop           # Lint
bash -n install/coop              # Syntax check
chmod +x install/coop             # Fix permissions
```

## Release Workflow

1. Update source project with changes
2. Tag release in source project: `git tag -a v1.0.0 -m "Release v1.0.0"`
3. Push tag: `git push origin v1.0.0`
4. GoReleaser runs, updates formula in this tap
5. Verify formula update: `git pull && make info`
6. Test installation: `brew install --build-from-source stuffbucket/tap/<formula>`

## Resources

- [Homebrew Formula Cookbook](https://docs.brew.sh/Formula-Cookbook)
- [GoReleaser Homebrew Documentation](https://goreleaser.com/customization/homebrew/)
- [Homebrew Tap Documentation](https://docs.brew.sh/Taps)
